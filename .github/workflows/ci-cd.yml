name: CI/CD Pipeline

on:
  push:
    branches: ['**'] # Run on push to any branch
  pull_request:
    branches: ['**']
  workflow_dispatch:

permissions:
  contents: read
  actions: write 

jobs:
  # ===============================================
  # CI JOBS (รันทุกครั้งที่มี PR หรือ Push)
  # ===============================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    # Run for pull requests OR for pushes to the main branch only
    # This avoids duplicate CI runs when a push triggers followed by a pull_request event
    if: github.event_name == 'pull_request' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Type check
        run: bun run type-check

  test:
    name: Test & Type Check
    runs-on: ubuntu-latest
    # Run for pull requests OR for pushes to the main branch only
    # Avoid duplicate runs for the same commit when both push and pull_request fire
    if: github.event_name == 'pull_request' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install ffmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Install dependencies
        run: bun install

      - name: Type check
        run: bun run type-check

      - name: Run tests
        run: bun test
        env:
          LINE_CHANNEL_SECRET: ${{ secrets.LINE_CHANNEL_SECRET || 'test-secret' }}
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN || 'test-token' }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL || 'https://test.supabase.co' }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY || 'test-key' }}
          AZURE_SPEECH_KEY: ${{ secrets.AZURE_SPEECH_KEY || 'test-key' }}
          AZURE_SPEECH_REGION: ${{ secrets.AZURE_SPEECH_REGION || 'test-region' }}

  # ===============================================
  # DEPLOY JOBS (รันเฉพาะตอน Push และ CI ผ่าน)
  # ===============================================
  deploy-development:
    name: Deploy to Development
    runs-on: ubuntu-latest
    
    # ⭐️ นี่คือส่วนสำคัญ! ⭐️
    # 1. needs: [lint, test] - บังคับให้ job นี้ต้องรอ 'lint' และ 'test' ผ่านก่อน
    # 2. if: ... - บังคับให้รันเฉพาะเมื่อเป็น 'push' (ไม่ใช่ PR) และต้องเป็น 'develop'
    needs: [lint, test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    
    environment: Development
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- ไม่จำเป็นต้อง test หรือ type-check ซ้ำ ---
      # เราลบขั้นตอน "Setup Bun", "Install ffmpeg", "Install dependencies"
      # และ "Type check" ออกจาก job นี้
      # เพราะ 'needs: [lint, test]' การันตีแล้วว่าโค้ดผ่านการตรวจสอบมาแล้ว
      # และการ Deploy ไปที่ Render (ด้วย action นี้) เป็นแค่การยิง API
      # ไม่จำเป็นต้องติดตั้ง dependencies บน runner ของ GitHub อีก
      #
      # หากคุณจำเป็นต้องใช้ gcloud credentials ในการรัน (ซึ่ง Render action ไม่น่าจะใช้)
      # ก็ยกเว้นขั้นตอนนี้ไว้ แต่ถ้าไม่ใช้ ก็ลบออกได้เลยครับ
      #
      # - name: Setup Google Cloud Credentials
      #   run: |
      #     echo "${{ secrets.GOOGLE_CREDENTIALS_JSON }}" > google-credentials.json
      #     echo "GOOGLE_APPLICATION_CREDENTIALS=./google-credentials.json" >> $GITHUB_ENV
      #   env:
      #     GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}

      - name: Deploy to Render
        uses: johnbeynon/render-deploy-action@v0.0.8
        with:
          service-id: ${{ secrets.RENDER_SERVICE_ID }}
          api-key: ${{ secrets.RENDER_API_KEY }}

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    
    # ⭐️ นี่คือส่วนสำคัญ! ⭐️
    # 1. needs: [lint, test] - บังคับให้ job นี้ต้องรอ 'lint' และ 'test' ผ่านก่อน
    # 2. if: ... - บังคับให้รันเฉพาะเมื่อเป็น 'push' (ไม่ใช่ PR) และต้องเป็น 'main'
    needs: [lint, test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    environment: Production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- เช่นเดียวกับด้านบน เราไม่จำเป็นต้องติดตั้งหรือตรวจสอบซ้ำ ---
      #
      # - name: Setup Google Cloud Credentials
      #   run: |
      #     echo "${{ secrets.GOOGLE_CREDENTIALS_JSON }}" > google-credentials.json
      #     echo "GOOGLE_APPLICATION_CREDENTIALS=./google-credentials.json" >> $GITHUB_ENV
      #   env:
      #     GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}

      - name: Deploy to Render
        uses: johnbeynon/render-deploy-action@v0.0.8
        with:
          service-id: ${{ secrets.RENDER_SERVICE_ID }}
          api-key: ${{ secrets.RENDER_API_KEY }}
