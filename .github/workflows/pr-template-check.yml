name: "PR template check"

on:
  pull_request:
    types: [opened, edited, reopened, synchronize]

jobs:
  check-template:
    name: Check PR body matches template
    runs-on: ubuntu-latest

    steps:
      - name: Check PR body
        uses: actions/github-script@v6
        with:
          script: |
            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = pr.number;
            const title = (pr.title || '').trim();
            const body = (pr.body || '').trim();

            const missing = [];
            if (!title) missing.push('PR title is empty');
            if (!body.includes('## üìù ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á')) missing.push('Missing section: "## üìù ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á (Description)"');
            // check for at least one markdown checklist item (- [ ] or - [x])
            if (!(/- \[.?\\]/.test(body))) missing.push('Checklist not found (no "- [ ]" items)');

            if (missing.length > 0) {
              const comment = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ üëã\n\nGitHub Action ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏ß‡πà‡∏≤ PR ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏ß‡πâ:\n\n${missing.map(m => `- ${m}`).join('\n')}\n\n‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞/‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏≤‡∏°‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï (‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå .github/PULL_REQUEST_TEMPLATE.md) ‡πÅ‡∏•‡πâ‡∏ß push commit ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡πà‡∏≤‡∏ô`;
              await github.rest.issues.createComment({ owner, repo, issue_number, body: comment });
              throw new Error('PR body does not match required template');
            } else {
              console.log('PR body matches basic template checks');
            }